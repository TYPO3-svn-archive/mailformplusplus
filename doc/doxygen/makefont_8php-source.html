<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>mailformplusplus: makefont.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>makefont.php</h1><a href="makefont_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00013"></a>00013 <span class="comment">/*******************************************************************************</span>
<a name="l00014"></a>00014 <span class="comment">* Utility to generate font definition files                                    *</span>
<a name="l00015"></a>00015 <span class="comment">*                                                                              *</span>
<a name="l00016"></a>00016 <span class="comment">* Version: 1.14                                                                *</span>
<a name="l00017"></a>00017 <span class="comment">* Date:    2008-08-03                                                          *</span>
<a name="l00018"></a>00018 <span class="comment">* Author:  Olivier PLATHEY                                                     *</span>
<a name="l00019"></a>00019 <span class="comment">*******************************************************************************/</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 
<a name="l00022"></a><a class="code" href="makefont_8php.html#e90b352d148d853ac7cb8488be9d199f">00022</a> function <a class="code" href="makefont_8php.html#e90b352d148d853ac7cb8488be9d199f">ReadMap</a>($enc)
<a name="l00023"></a>00023 {
<a name="l00024"></a>00024         <span class="comment">//Read a map file</span>
<a name="l00025"></a>00025         $file=dirname(__FILE__).<span class="charliteral">'/'</span>.strtolower($enc).<span class="stringliteral">'.map'</span>;
<a name="l00026"></a>00026         $a=file($file);
<a name="l00027"></a>00027         <span class="keywordflow">if</span>(empty($a))
<a name="l00028"></a>00028                 die(<span class="stringliteral">'&lt;b&gt;Error:&lt;/b&gt; encoding not found: '</span>.$enc);
<a name="l00029"></a>00029         $cc2gn=array();
<a name="l00030"></a>00030         <span class="keywordflow">foreach</span>($a as $l)
<a name="l00031"></a>00031         {
<a name="l00032"></a>00032                 <span class="keywordflow">if</span>($l[0]==<span class="charliteral">'!'</span>)
<a name="l00033"></a>00033                 {
<a name="l00034"></a>00034                         $e=preg_split(<span class="stringliteral">'/[ \\t]+/'</span>,rtrim($l));
<a name="l00035"></a>00035                         $cc=hexdec(substr($e[0],1));
<a name="l00036"></a>00036                         $gn=$e[2];
<a name="l00037"></a>00037                         $cc2gn[$cc]=$gn;
<a name="l00038"></a>00038                 }
<a name="l00039"></a>00039         }
<a name="l00040"></a>00040         <span class="keywordflow">for</span>($i=0;$i&lt;=255;$i++)
<a name="l00041"></a>00041         {
<a name="l00042"></a>00042                 <span class="keywordflow">if</span>(!isset($cc2gn[$i]))
<a name="l00043"></a>00043                         $cc2gn[$i]=<span class="stringliteral">'.notdef'</span>;
<a name="l00044"></a>00044         }
<a name="l00045"></a>00045         <span class="keywordflow">return</span> $cc2gn;
<a name="l00046"></a>00046 }
<a name="l00047"></a>00047 
<a name="l00048"></a><a class="code" href="makefont_8php.html#05153df7750f31a517f7fab3b0afb1a7">00048</a> function <a class="code" href="makefont_8php.html#05153df7750f31a517f7fab3b0afb1a7">ReadAFM</a>($file, &amp;$map)
<a name="l00049"></a>00049 {
<a name="l00050"></a>00050         <span class="comment">//Read a font metric file</span>
<a name="l00051"></a>00051         $a=file($file);
<a name="l00052"></a>00052         <span class="keywordflow">if</span>(empty($a))
<a name="l00053"></a>00053                 die(<span class="stringliteral">'File not found'</span>);
<a name="l00054"></a>00054         $widths=array();
<a name="l00055"></a>00055         $fm=array();
<a name="l00056"></a>00056         $fix=array(<span class="stringliteral">'Edot'</span>=&gt;<span class="stringliteral">'Edotaccent'</span>,<span class="stringliteral">'edot'</span>=&gt;<span class="stringliteral">'edotaccent'</span>,<span class="stringliteral">'Idot'</span>=&gt;<span class="stringliteral">'Idotaccent'</span>,<span class="stringliteral">'Zdot'</span>=&gt;<span class="stringliteral">'Zdotaccent'</span>,<span class="stringliteral">'zdot'</span>=&gt;<span class="stringliteral">'zdotaccent'</span>,
<a name="l00057"></a>00057                 <span class="stringliteral">'Odblacute'</span>=&gt;<span class="stringliteral">'Ohungarumlaut'</span>,<span class="stringliteral">'odblacute'</span>=&gt;<span class="stringliteral">'ohungarumlaut'</span>,<span class="stringliteral">'Udblacute'</span>=&gt;<span class="stringliteral">'Uhungarumlaut'</span>,<span class="stringliteral">'udblacute'</span>=&gt;<span class="stringliteral">'uhungarumlaut'</span>,
<a name="l00058"></a>00058                 <span class="stringliteral">'Gcedilla'</span>=&gt;<span class="stringliteral">'Gcommaaccent'</span>,<span class="stringliteral">'gcedilla'</span>=&gt;<span class="stringliteral">'gcommaaccent'</span>,<span class="stringliteral">'Kcedilla'</span>=&gt;<span class="stringliteral">'Kcommaaccent'</span>,<span class="stringliteral">'kcedilla'</span>=&gt;<span class="stringliteral">'kcommaaccent'</span>,
<a name="l00059"></a>00059                 <span class="stringliteral">'Lcedilla'</span>=&gt;<span class="stringliteral">'Lcommaaccent'</span>,<span class="stringliteral">'lcedilla'</span>=&gt;<span class="stringliteral">'lcommaaccent'</span>,<span class="stringliteral">'Ncedilla'</span>=&gt;<span class="stringliteral">'Ncommaaccent'</span>,<span class="stringliteral">'ncedilla'</span>=&gt;<span class="stringliteral">'ncommaaccent'</span>,
<a name="l00060"></a>00060                 <span class="stringliteral">'Rcedilla'</span>=&gt;<span class="stringliteral">'Rcommaaccent'</span>,<span class="stringliteral">'rcedilla'</span>=&gt;<span class="stringliteral">'rcommaaccent'</span>,<span class="stringliteral">'Scedilla'</span>=&gt;<span class="stringliteral">'Scommaaccent'</span>,<span class="stringliteral">'scedilla'</span>=&gt;<span class="stringliteral">'scommaaccent'</span>,
<a name="l00061"></a>00061                 <span class="stringliteral">'Tcedilla'</span>=&gt;<span class="stringliteral">'Tcommaaccent'</span>,<span class="stringliteral">'tcedilla'</span>=&gt;<span class="stringliteral">'tcommaaccent'</span>,<span class="stringliteral">'Dslash'</span>=&gt;<span class="stringliteral">'Dcroat'</span>,<span class="stringliteral">'dslash'</span>=&gt;<span class="stringliteral">'dcroat'</span>,<span class="stringliteral">'Dmacron'</span>=&gt;<span class="stringliteral">'Dcroat'</span>,<span class="stringliteral">'dmacron'</span>=&gt;<span class="stringliteral">'dcroat'</span>,
<a name="l00062"></a>00062                 <span class="stringliteral">'combininggraveaccent'</span>=&gt;<span class="stringliteral">'gravecomb'</span>,<span class="stringliteral">'combininghookabove'</span>=&gt;<span class="stringliteral">'hookabovecomb'</span>,<span class="stringliteral">'combiningtildeaccent'</span>=&gt;<span class="stringliteral">'tildecomb'</span>,
<a name="l00063"></a>00063                 <span class="stringliteral">'combiningacuteaccent'</span>=&gt;<span class="stringliteral">'acutecomb'</span>,<span class="stringliteral">'combiningdotbelow'</span>=&gt;<span class="stringliteral">'dotbelowcomb'</span>,<span class="stringliteral">'dongsign'</span>=&gt;<span class="stringliteral">'dong'</span>);
<a name="l00064"></a>00064         <span class="keywordflow">foreach</span>($a as $l)
<a name="l00065"></a>00065         {
<a name="l00066"></a>00066                 $e=explode(<span class="charliteral">' '</span>,rtrim($l));
<a name="l00067"></a>00067                 <span class="keywordflow">if</span>(count($e)&lt;2)
<a name="l00068"></a>00068                         <span class="keywordflow">continue</span>;
<a name="l00069"></a>00069                 $code=$e[0];
<a name="l00070"></a>00070                 $param=$e[1];
<a name="l00071"></a>00071                 <span class="keywordflow">if</span>($code==<span class="charliteral">'C'</span>)
<a name="l00072"></a>00072                 {
<a name="l00073"></a>00073                         <span class="comment">//Character metrics</span>
<a name="l00074"></a>00074                         $cc=(int)$e[1];
<a name="l00075"></a>00075                         $w=$e[4];
<a name="l00076"></a>00076                         $gn=$e[7];
<a name="l00077"></a>00077                         <span class="keywordflow">if</span>(substr($gn,-4)==<span class="stringliteral">'20AC'</span>)
<a name="l00078"></a>00078                                 $gn=<span class="stringliteral">'Euro'</span>;
<a name="l00079"></a>00079                         <span class="keywordflow">if</span>(isset($fix[$gn]))
<a name="l00080"></a>00080                         {
<a name="l00081"></a>00081                                 <span class="comment">//Fix incorrect glyph name</span>
<a name="l00082"></a>00082                                 <span class="keywordflow">foreach</span>($map as $c=&gt;$n)
<a name="l00083"></a>00083                                 {
<a name="l00084"></a>00084                                         <span class="keywordflow">if</span>($n==$fix[$gn])
<a name="l00085"></a>00085                                                 $map[$c]=$gn;
<a name="l00086"></a>00086                                 }
<a name="l00087"></a>00087                         }
<a name="l00088"></a>00088                         <span class="keywordflow">if</span>(empty($map))
<a name="l00089"></a>00089                         {
<a name="l00090"></a>00090                                 <span class="comment">//Symbolic font: use built-in encoding</span>
<a name="l00091"></a>00091                                 $widths[$cc]=$w;
<a name="l00092"></a>00092                         }
<a name="l00093"></a>00093                         <span class="keywordflow">else</span>
<a name="l00094"></a>00094                         {
<a name="l00095"></a>00095                                 $widths[$gn]=$w;
<a name="l00096"></a>00096                                 <span class="keywordflow">if</span>($gn==<span class="charliteral">'X'</span>)
<a name="l00097"></a>00097                                         $fm[<span class="stringliteral">'CapXHeight'</span>]=$e[13];
<a name="l00098"></a>00098                         }
<a name="l00099"></a>00099                         <span class="keywordflow">if</span>($gn==<span class="stringliteral">'.notdef'</span>)
<a name="l00100"></a>00100                                 $fm[<span class="stringliteral">'MissingWidth'</span>]=$w;
<a name="l00101"></a>00101                 }
<a name="l00102"></a>00102                 elseif($code==<span class="stringliteral">'FontName'</span>)
<a name="l00103"></a>00103                         $fm[<span class="stringliteral">'FontName'</span>]=$param;
<a name="l00104"></a>00104                 elseif($code==<span class="stringliteral">'Weight'</span>)
<a name="l00105"></a>00105                         $fm[<span class="stringliteral">'Weight'</span>]=$param;
<a name="l00106"></a>00106                 elseif($code==<span class="stringliteral">'ItalicAngle'</span>)
<a name="l00107"></a>00107                         $fm[<span class="stringliteral">'ItalicAngle'</span>]=(double)$param;
<a name="l00108"></a>00108                 elseif($code==<span class="stringliteral">'Ascender'</span>)
<a name="l00109"></a>00109                         $fm[<span class="stringliteral">'Ascender'</span>]=(int)$param;
<a name="l00110"></a>00110                 elseif($code==<span class="stringliteral">'Descender'</span>)
<a name="l00111"></a>00111                         $fm[<span class="stringliteral">'Descender'</span>]=(int)$param;
<a name="l00112"></a>00112                 elseif($code==<span class="stringliteral">'UnderlineThickness'</span>)
<a name="l00113"></a>00113                         $fm[<span class="stringliteral">'UnderlineThickness'</span>]=(int)$param;
<a name="l00114"></a>00114                 elseif($code==<span class="stringliteral">'UnderlinePosition'</span>)
<a name="l00115"></a>00115                         $fm[<span class="stringliteral">'UnderlinePosition'</span>]=(int)$param;
<a name="l00116"></a>00116                 elseif($code==<span class="stringliteral">'IsFixedPitch'</span>)
<a name="l00117"></a>00117                         $fm[<span class="stringliteral">'IsFixedPitch'</span>]=($param==<span class="stringliteral">'true'</span>);
<a name="l00118"></a>00118                 elseif($code==<span class="stringliteral">'FontBBox'</span>)
<a name="l00119"></a>00119                         $fm[<span class="stringliteral">'FontBBox'</span>]=array($e[1],$e[2],$e[3],$e[4]);
<a name="l00120"></a>00120                 elseif($code==<span class="stringliteral">'CapHeight'</span>)
<a name="l00121"></a>00121                         $fm[<span class="stringliteral">'CapHeight'</span>]=(int)$param;
<a name="l00122"></a>00122                 elseif($code==<span class="stringliteral">'StdVW'</span>)
<a name="l00123"></a>00123                         $fm[<span class="stringliteral">'StdVW'</span>]=(int)$param;
<a name="l00124"></a>00124         }
<a name="l00125"></a>00125         <span class="keywordflow">if</span>(!isset($fm[<span class="stringliteral">'FontName'</span>]))
<a name="l00126"></a>00126                 die(<span class="stringliteral">'FontName not found'</span>);
<a name="l00127"></a>00127         <span class="keywordflow">if</span>(!empty($map))
<a name="l00128"></a>00128         {
<a name="l00129"></a>00129                 <span class="keywordflow">if</span>(!isset($widths[<span class="stringliteral">'.notdef'</span>]))
<a name="l00130"></a>00130                         $widths[<span class="stringliteral">'.notdef'</span>]=600;
<a name="l00131"></a>00131                 <span class="keywordflow">if</span>(!isset($widths[<span class="stringliteral">'Delta'</span>]) &amp;&amp; isset($widths[<span class="stringliteral">'increment'</span>]))
<a name="l00132"></a>00132                         $widths[<span class="stringliteral">'Delta'</span>]=$widths[<span class="stringliteral">'increment'</span>];
<a name="l00133"></a>00133                 <span class="comment">//Order widths according to map</span>
<a name="l00134"></a>00134                 <span class="keywordflow">for</span>($i=0;$i&lt;=255;$i++)
<a name="l00135"></a>00135                 {
<a name="l00136"></a>00136                         <span class="keywordflow">if</span>(!isset($widths[$map[$i]]))
<a name="l00137"></a>00137                         {
<a name="l00138"></a>00138                                 echo <span class="stringliteral">'&lt;b&gt;Warning:&lt;/b&gt; character '</span>.$map[$i].<span class="stringliteral">' is missing&lt;br&gt;'</span>;
<a name="l00139"></a>00139                                 $widths[$i]=$widths[<span class="stringliteral">'.notdef'</span>];
<a name="l00140"></a>00140                         }
<a name="l00141"></a>00141                         <span class="keywordflow">else</span>
<a name="l00142"></a>00142                                 $widths[$i]=$widths[$map[$i]];
<a name="l00143"></a>00143                 }
<a name="l00144"></a>00144         }
<a name="l00145"></a>00145         $fm[<span class="stringliteral">'Widths'</span>]=$widths;
<a name="l00146"></a>00146         <span class="keywordflow">return</span> $fm;
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="makefont_8php.html#6e3d2e58bb5546f47003a43606f89324">00149</a> function <a class="code" href="makefont_8php.html#6e3d2e58bb5546f47003a43606f89324">MakeFontDescriptor</a>($fm, $symbolic)
<a name="l00150"></a>00150 {
<a name="l00151"></a>00151         <span class="comment">//Ascent</span>
<a name="l00152"></a>00152         $asc=(isset($fm[<span class="stringliteral">'Ascender'</span>]) ? $fm[<span class="stringliteral">'Ascender'</span>] : 1000);
<a name="l00153"></a>00153         $fd=<span class="stringliteral">"array('Ascent'=&gt;"</span>.$asc;
<a name="l00154"></a>00154         <span class="comment">//Descent</span>
<a name="l00155"></a>00155         $desc=(isset($fm[<span class="stringliteral">'Descender'</span>]) ? $fm[<span class="stringliteral">'Descender'</span>] : -200);
<a name="l00156"></a>00156         $fd.=<span class="stringliteral">",'Descent'=&gt;"</span>.$desc;
<a name="l00157"></a>00157         <span class="comment">//CapHeight</span>
<a name="l00158"></a>00158         <span class="keywordflow">if</span>(isset($fm[<span class="stringliteral">'CapHeight'</span>]))
<a name="l00159"></a>00159                 $ch=$fm[<span class="stringliteral">'CapHeight'</span>];
<a name="l00160"></a>00160         elseif(isset($fm[<span class="stringliteral">'CapXHeight'</span>]))
<a name="l00161"></a>00161                 $ch=$fm[<span class="stringliteral">'CapXHeight'</span>];
<a name="l00162"></a>00162         <span class="keywordflow">else</span>
<a name="l00163"></a>00163                 $ch=$asc;
<a name="l00164"></a>00164         $fd.=<span class="stringliteral">",'CapHeight'=&gt;"</span>.$ch;
<a name="l00165"></a>00165         <span class="comment">//Flags</span>
<a name="l00166"></a>00166         $flags=0;
<a name="l00167"></a>00167         <span class="keywordflow">if</span>(isset($fm[<span class="stringliteral">'IsFixedPitch'</span>]) &amp;&amp; $fm[<span class="stringliteral">'IsFixedPitch'</span>])
<a name="l00168"></a>00168                 $flags+=1&lt;&lt;0;
<a name="l00169"></a>00169         <span class="keywordflow">if</span>($symbolic)
<a name="l00170"></a>00170                 $flags+=1&lt;&lt;2;
<a name="l00171"></a>00171         <span class="keywordflow">if</span>(!$symbolic)
<a name="l00172"></a>00172                 $flags+=1&lt;&lt;5;
<a name="l00173"></a>00173         <span class="keywordflow">if</span>(isset($fm[<span class="stringliteral">'ItalicAngle'</span>]) &amp;&amp; $fm[<span class="stringliteral">'ItalicAngle'</span>]!=0)
<a name="l00174"></a>00174                 $flags+=1&lt;&lt;6;
<a name="l00175"></a>00175         $fd.=<span class="stringliteral">",'Flags'=&gt;"</span>.$flags;
<a name="l00176"></a>00176         <span class="comment">//FontBBox</span>
<a name="l00177"></a>00177         <span class="keywordflow">if</span>(isset($fm[<span class="stringliteral">'FontBBox'</span>]))
<a name="l00178"></a>00178                 $fbb=$fm[<span class="stringliteral">'FontBBox'</span>];
<a name="l00179"></a>00179         <span class="keywordflow">else</span>
<a name="l00180"></a>00180                 $fbb=array(0,$desc-100,1000,$asc+100);
<a name="l00181"></a>00181         $fd.=<span class="stringliteral">",'FontBBox'=&gt;'["</span>.$fbb[0].<span class="charliteral">' '</span>.$fbb[1].<span class="charliteral">' '</span>.$fbb[2].<span class="charliteral">' '</span>.$fbb[3].<span class="stringliteral">"]'"</span>;
<a name="l00182"></a>00182         <span class="comment">//ItalicAngle</span>
<a name="l00183"></a>00183         $ia=(isset($fm[<span class="stringliteral">'ItalicAngle'</span>]) ? $fm[<span class="stringliteral">'ItalicAngle'</span>] : 0);
<a name="l00184"></a>00184         $fd.=<span class="stringliteral">",'ItalicAngle'=&gt;"</span>.$ia;
<a name="l00185"></a>00185         <span class="comment">//StemV</span>
<a name="l00186"></a>00186         <span class="keywordflow">if</span>(isset($fm[<span class="stringliteral">'StdVW'</span>]))
<a name="l00187"></a>00187                 $stemv=$fm[<span class="stringliteral">'StdVW'</span>];
<a name="l00188"></a>00188         elseif(isset($fm[<span class="stringliteral">'Weight'</span>]) &amp;&amp; preg_match(<span class="stringliteral">'/bold|black/i'</span>,$fm[<span class="stringliteral">'Weight'</span>]))
<a name="l00189"></a>00189                 $stemv=120;
<a name="l00190"></a>00190         <span class="keywordflow">else</span>
<a name="l00191"></a>00191                 $stemv=70;
<a name="l00192"></a>00192         $fd.=<span class="stringliteral">",'StemV'=&gt;"</span>.$stemv;
<a name="l00193"></a>00193         <span class="comment">//MissingWidth</span>
<a name="l00194"></a>00194         <span class="keywordflow">if</span>(isset($fm[<span class="stringliteral">'MissingWidth'</span>]))
<a name="l00195"></a>00195                 $fd.=<span class="stringliteral">",'MissingWidth'=&gt;"</span>.$fm[<span class="stringliteral">'MissingWidth'</span>];
<a name="l00196"></a>00196         $fd.=<span class="charliteral">')'</span>;
<a name="l00197"></a>00197         <span class="keywordflow">return</span> $fd;
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a><a class="code" href="makefont_8php.html#40178149f9fc4ceefe18e85a8ee72b5d">00200</a> function <a class="code" href="makefont_8php.html#40178149f9fc4ceefe18e85a8ee72b5d">MakeWidthArray</a>($fm)
<a name="l00201"></a>00201 {
<a name="l00202"></a>00202         <span class="comment">//Make character width array</span>
<a name="l00203"></a>00203         $s=<span class="stringliteral">"array(\n\t"</span>;
<a name="l00204"></a>00204         $cw=$fm[<span class="stringliteral">'Widths'</span>];
<a name="l00205"></a>00205         <span class="keywordflow">for</span>($i=0;$i&lt;=255;$i++)
<a name="l00206"></a>00206         {
<a name="l00207"></a>00207                 <span class="keywordflow">if</span>(chr($i)==<span class="stringliteral">"'"</span>)
<a name="l00208"></a>00208                         $s.=<span class="stringliteral">"'\\''"</span>;
<a name="l00209"></a>00209                 elseif(chr($i)==<span class="stringliteral">"\\"</span>)
<a name="l00210"></a>00210                         $s.=<span class="stringliteral">"'\\\\'"</span>;
<a name="l00211"></a>00211                 elseif($i&gt;=32 &amp;&amp; $i&lt;=126)
<a name="l00212"></a>00212                         $s.=<span class="stringliteral">"'"</span>.chr($i).<span class="stringliteral">"'"</span>;
<a name="l00213"></a>00213                 <span class="keywordflow">else</span>
<a name="l00214"></a>00214                         $s.=<span class="stringliteral">"chr($i)"</span>;
<a name="l00215"></a>00215                 $s.=<span class="stringliteral">'=&gt;'</span>.$fm[<span class="stringliteral">'Widths'</span>][$i];
<a name="l00216"></a>00216                 <span class="keywordflow">if</span>($i&lt;255)
<a name="l00217"></a>00217                         $s.=<span class="charliteral">','</span>;
<a name="l00218"></a>00218                 <span class="keywordflow">if</span>(($i+1)%22==0)
<a name="l00219"></a>00219                         $s.=<span class="stringliteral">"\n\t"</span>;
<a name="l00220"></a>00220         }
<a name="l00221"></a>00221         $s.=<span class="charliteral">')'</span>;
<a name="l00222"></a>00222         <span class="keywordflow">return</span> $s;
<a name="l00223"></a>00223 }
<a name="l00224"></a>00224 
<a name="l00225"></a><a class="code" href="makefont_8php.html#6a51afba9135056d951a104d55f6af12">00225</a> function <a class="code" href="makefont_8php.html#6a51afba9135056d951a104d55f6af12">MakeFontEncoding</a>($map)
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227         <span class="comment">//Build differences from reference encoding</span>
<a name="l00228"></a>00228         $ref=<a class="code" href="makefont_8php.html#e90b352d148d853ac7cb8488be9d199f">ReadMap</a>(<span class="stringliteral">'cp1252'</span>);
<a name="l00229"></a>00229         $s=<span class="stringliteral">''</span>;
<a name="l00230"></a>00230         $last=0;
<a name="l00231"></a>00231         <span class="keywordflow">for</span>($i=32;$i&lt;=255;$i++)
<a name="l00232"></a>00232         {
<a name="l00233"></a>00233                 <span class="keywordflow">if</span>($map[$i]!=$ref[$i])
<a name="l00234"></a>00234                 {
<a name="l00235"></a>00235                         <span class="keywordflow">if</span>($i!=$last+1)
<a name="l00236"></a>00236                                 $s.=$i.<span class="charliteral">' '</span>;
<a name="l00237"></a>00237                         $last=$i;
<a name="l00238"></a>00238                         $s.=<span class="charliteral">'/'</span>.$map[$i].<span class="charliteral">' '</span>;
<a name="l00239"></a>00239                 }
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241         <span class="keywordflow">return</span> rtrim($s);
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00244"></a><a class="code" href="makefont_8php.html#bd2121a3e400e1df96d0dac02ade77a2">00244</a> function <a class="code" href="makefont_8php.html#bd2121a3e400e1df96d0dac02ade77a2">SaveToFile</a>($file, $s, $mode)
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246         $f=fopen($file,<span class="charliteral">'w'</span>.$mode);
<a name="l00247"></a>00247         <span class="keywordflow">if</span>(!$f)
<a name="l00248"></a>00248                 die(<span class="stringliteral">'Can\'t write to file '</span>.$file);
<a name="l00249"></a>00249         fwrite($f,$s,strlen($s));
<a name="l00250"></a>00250         fclose($f);
<a name="l00251"></a>00251 }
<a name="l00252"></a>00252 
<a name="l00253"></a><a class="code" href="makefont_8php.html#6d8bd1fd7e2f3ecdc21ef2b31566b4c0">00253</a> function <a class="code" href="makefont_8php.html#6d8bd1fd7e2f3ecdc21ef2b31566b4c0">ReadShort</a>($f)
<a name="l00254"></a>00254 {
<a name="l00255"></a>00255         $a=unpack(<span class="stringliteral">'n1n'</span>,fread($f,2));
<a name="l00256"></a>00256         <span class="keywordflow">return</span> $a[<span class="charliteral">'n'</span>];
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00259"></a><a class="code" href="makefont_8php.html#75e09243fcc909c5e7eee12a1a8443ce">00259</a> function <a class="code" href="makefont_8php.html#75e09243fcc909c5e7eee12a1a8443ce">ReadLong</a>($f)
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261         $a=unpack(<span class="stringliteral">'N1N'</span>,fread($f,4));
<a name="l00262"></a>00262         <span class="keywordflow">return</span> $a[<span class="charliteral">'N'</span>];
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00265"></a><a class="code" href="makefont_8php.html#77e282eb3da32ac811d34defeb16c071">00265</a> function <a class="code" href="makefont_8php.html#77e282eb3da32ac811d34defeb16c071">CheckTTF</a>($file)
<a name="l00266"></a>00266 {
<a name="l00267"></a>00267         <span class="comment">//Check if font license allows embedding</span>
<a name="l00268"></a>00268         $f=fopen($file,<span class="stringliteral">'rb'</span>);
<a name="l00269"></a>00269         <span class="keywordflow">if</span>(!$f)
<a name="l00270"></a>00270                 die(<span class="stringliteral">'&lt;b&gt;Error:&lt;/b&gt; Can\'t open '</span>.$file);
<a name="l00271"></a>00271         <span class="comment">//Extract number of tables</span>
<a name="l00272"></a>00272         fseek($f,4,SEEK_CUR);
<a name="l00273"></a>00273         $nb=<a class="code" href="makefont_8php.html#6d8bd1fd7e2f3ecdc21ef2b31566b4c0">ReadShort</a>($f);
<a name="l00274"></a>00274         fseek($f,6,SEEK_CUR);
<a name="l00275"></a>00275         <span class="comment">//Seek OS/2 table</span>
<a name="l00276"></a>00276         $found=<span class="keyword">false</span>;
<a name="l00277"></a>00277         <span class="keywordflow">for</span>($i=0;$i&lt;$nb;$i++)
<a name="l00278"></a>00278         {
<a name="l00279"></a>00279                 <span class="keywordflow">if</span>(fread($f,4)==<span class="stringliteral">'OS/2'</span>)
<a name="l00280"></a>00280                 {
<a name="l00281"></a>00281                         $found=<span class="keyword">true</span>;
<a name="l00282"></a>00282                         <span class="keywordflow">break</span>;
<a name="l00283"></a>00283                 }
<a name="l00284"></a>00284                 fseek($f,12,SEEK_CUR);
<a name="l00285"></a>00285         }
<a name="l00286"></a>00286         <span class="keywordflow">if</span>(!$found)
<a name="l00287"></a>00287         {
<a name="l00288"></a>00288                 fclose($f);
<a name="l00289"></a>00289                 <span class="keywordflow">return</span>;
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291         fseek($f,4,SEEK_CUR);
<a name="l00292"></a>00292         $offset=<a class="code" href="makefont_8php.html#75e09243fcc909c5e7eee12a1a8443ce">ReadLong</a>($f);
<a name="l00293"></a>00293         fseek($f,$offset,SEEK_SET);
<a name="l00294"></a>00294         <span class="comment">//Extract fsType flags</span>
<a name="l00295"></a>00295         fseek($f,8,SEEK_CUR);
<a name="l00296"></a>00296         $fsType=<a class="code" href="makefont_8php.html#6d8bd1fd7e2f3ecdc21ef2b31566b4c0">ReadShort</a>($f);
<a name="l00297"></a>00297         $rl=($fsType &amp; 0x02)!=0;
<a name="l00298"></a>00298         $pp=($fsType &amp; 0x04)!=0;
<a name="l00299"></a>00299         $e=($fsType &amp; 0x08)!=0;
<a name="l00300"></a>00300         fclose($f);
<a name="l00301"></a>00301         <span class="keywordflow">if</span>($rl &amp;&amp; !$pp &amp;&amp; !$e)
<a name="l00302"></a>00302                 echo <span class="stringliteral">'&lt;b&gt;Warning:&lt;/b&gt; font license does not allow embedding'</span>;
<a name="l00303"></a>00303 }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 <span class="comment">/*******************************************************************************</span>
<a name="l00306"></a>00306 <span class="comment">* fontfile: path to TTF file (or empty string if not to be embedded)           *</span>
<a name="l00307"></a>00307 <span class="comment">* afmfile:  path to AFM file                                                   *</span>
<a name="l00308"></a>00308 <span class="comment">* enc:      font encoding (or empty string for symbolic fonts)                 *</span>
<a name="l00309"></a>00309 <span class="comment">* patch:    optional patch for encoding                                        *</span>
<a name="l00310"></a>00310 <span class="comment">* type:     font type if fontfile is empty                                     *</span>
<a name="l00311"></a>00311 <span class="comment">*******************************************************************************/</span>
<a name="l00312"></a><a class="code" href="makefont_8php.html#8ee25a4dbcc0f5237a1d8a2a63f61a32">00312</a> function <a class="code" href="makefont_8php.html#8ee25a4dbcc0f5237a1d8a2a63f61a32">MakeFont</a>($fontfile, $afmfile, $enc=<span class="stringliteral">'cp1252'</span>, $patch=array(), $type=<span class="stringliteral">'TrueType'</span>)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314         <span class="comment">//Generate a font definition file</span>
<a name="l00315"></a>00315         <span class="keywordflow">if</span>(get_magic_quotes_runtime())
<a name="l00316"></a>00316                 @set_magic_quotes_runtime(0);
<a name="l00317"></a>00317         ini_set(<span class="stringliteral">'auto_detect_line_endings'</span>,<span class="charliteral">'1'</span>);
<a name="l00318"></a>00318         <span class="keywordflow">if</span>($enc)
<a name="l00319"></a>00319         {
<a name="l00320"></a>00320                 $map=<a class="code" href="makefont_8php.html#e90b352d148d853ac7cb8488be9d199f">ReadMap</a>($enc);
<a name="l00321"></a>00321                 <span class="keywordflow">foreach</span>($patch as $cc=&gt;$gn)
<a name="l00322"></a>00322                         $map[$cc]=$gn;
<a name="l00323"></a>00323         }
<a name="l00324"></a>00324         <span class="keywordflow">else</span>
<a name="l00325"></a>00325                 $map=array();
<a name="l00326"></a>00326         <span class="keywordflow">if</span>(!file_exists($afmfile))
<a name="l00327"></a>00327                 die(<span class="stringliteral">'&lt;b&gt;Error:&lt;/b&gt; AFM file not found: '</span>.$afmfile);
<a name="l00328"></a>00328         $fm=<a class="code" href="makefont_8php.html#05153df7750f31a517f7fab3b0afb1a7">ReadAFM</a>($afmfile,$map);
<a name="l00329"></a>00329         <span class="keywordflow">if</span>($enc)
<a name="l00330"></a>00330                 $diff=<a class="code" href="makefont_8php.html#6a51afba9135056d951a104d55f6af12">MakeFontEncoding</a>($map);
<a name="l00331"></a>00331         <span class="keywordflow">else</span>
<a name="l00332"></a>00332                 $diff=<span class="stringliteral">''</span>;
<a name="l00333"></a>00333         $fd=<a class="code" href="makefont_8php.html#6e3d2e58bb5546f47003a43606f89324">MakeFontDescriptor</a>($fm,empty($map));
<a name="l00334"></a>00334         <span class="comment">//Find font type</span>
<a name="l00335"></a>00335         <span class="keywordflow">if</span>($fontfile)
<a name="l00336"></a>00336         {
<a name="l00337"></a>00337                 $ext=strtolower(substr($fontfile,-3));
<a name="l00338"></a>00338                 <span class="keywordflow">if</span>($ext==<span class="stringliteral">'ttf'</span>)
<a name="l00339"></a>00339                         $type=<span class="stringliteral">'TrueType'</span>;
<a name="l00340"></a>00340                 elseif($ext==<span class="stringliteral">'pfb'</span>)
<a name="l00341"></a>00341                         $type=<span class="stringliteral">'Type1'</span>;
<a name="l00342"></a>00342                 <span class="keywordflow">else</span>
<a name="l00343"></a>00343                         die(<span class="stringliteral">'&lt;b&gt;Error:&lt;/b&gt; unrecognized font file extension: '</span>.$ext);
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345         <span class="keywordflow">else</span>
<a name="l00346"></a>00346         {
<a name="l00347"></a>00347                 <span class="keywordflow">if</span>($type!=<span class="stringliteral">'TrueType'</span> &amp;&amp; $type!=<span class="stringliteral">'Type1'</span>)
<a name="l00348"></a>00348                         die(<span class="stringliteral">'&lt;b&gt;Error:&lt;/b&gt; incorrect font type: '</span>.$type);
<a name="l00349"></a>00349         }
<a name="l00350"></a>00350         <span class="comment">//Start generation</span>
<a name="l00351"></a>00351         $s=<span class="stringliteral">'&lt;?php'</span>.<span class="stringliteral">"\n"</span>;
<a name="l00352"></a>00352         $s.=<span class="stringliteral">'$type=\''</span>.$type.<span class="stringliteral">"';\n"</span>;
<a name="l00353"></a>00353         $s.=<span class="stringliteral">'$name=\''</span>.$fm[<span class="stringliteral">'FontName'</span>].<span class="stringliteral">"';\n"</span>;
<a name="l00354"></a>00354         $s.=<span class="stringliteral">'$desc='</span>.$fd.<span class="stringliteral">";\n"</span>;
<a name="l00355"></a>00355         <span class="keywordflow">if</span>(!isset($fm[<span class="stringliteral">'UnderlinePosition'</span>]))
<a name="l00356"></a>00356                 $fm[<span class="stringliteral">'UnderlinePosition'</span>]=-100;
<a name="l00357"></a>00357         <span class="keywordflow">if</span>(!isset($fm[<span class="stringliteral">'UnderlineThickness'</span>]))
<a name="l00358"></a>00358                 $fm[<span class="stringliteral">'UnderlineThickness'</span>]=50;
<a name="l00359"></a>00359         $s.=<span class="stringliteral">'$up='</span>.$fm[<span class="stringliteral">'UnderlinePosition'</span>].<span class="stringliteral">";\n"</span>;
<a name="l00360"></a>00360         $s.=<span class="stringliteral">'$ut='</span>.$fm[<span class="stringliteral">'UnderlineThickness'</span>].<span class="stringliteral">";\n"</span>;
<a name="l00361"></a>00361         $w=<a class="code" href="makefont_8php.html#40178149f9fc4ceefe18e85a8ee72b5d">MakeWidthArray</a>($fm);
<a name="l00362"></a>00362         $s.=<span class="stringliteral">'$cw='</span>.$w.<span class="stringliteral">";\n"</span>;
<a name="l00363"></a>00363         $s.=<span class="stringliteral">'$enc=\''</span>.$enc.<span class="stringliteral">"';\n"</span>;
<a name="l00364"></a>00364         $s.=<span class="stringliteral">'$diff=\''</span>.$diff.<span class="stringliteral">"';\n"</span>;
<a name="l00365"></a>00365         $basename=substr(basename($afmfile),0,-4);
<a name="l00366"></a>00366         <span class="keywordflow">if</span>($fontfile)
<a name="l00367"></a>00367         {
<a name="l00368"></a>00368                 <span class="comment">//Embedded font</span>
<a name="l00369"></a>00369                 <span class="keywordflow">if</span>(!file_exists($fontfile))
<a name="l00370"></a>00370                         die(<span class="stringliteral">'&lt;b&gt;Error:&lt;/b&gt; font file not found: '</span>.$fontfile);
<a name="l00371"></a>00371                 <span class="keywordflow">if</span>($type==<span class="stringliteral">'TrueType'</span>)
<a name="l00372"></a>00372                         <a class="code" href="makefont_8php.html#77e282eb3da32ac811d34defeb16c071">CheckTTF</a>($fontfile);
<a name="l00373"></a>00373                 $f=fopen($fontfile,<span class="stringliteral">'rb'</span>);
<a name="l00374"></a>00374                 <span class="keywordflow">if</span>(!$f)
<a name="l00375"></a>00375                         die(<span class="stringliteral">'&lt;b&gt;Error:&lt;/b&gt; Can\'t open '</span>.$fontfile);
<a name="l00376"></a>00376                 $file=fread($f,filesize($fontfile));
<a name="l00377"></a>00377                 fclose($f);
<a name="l00378"></a>00378                 <span class="keywordflow">if</span>($type==<span class="stringliteral">'Type1'</span>)
<a name="l00379"></a>00379                 {
<a name="l00380"></a>00380                         <span class="comment">//Find first two sections and discard third one</span>
<a name="l00381"></a>00381                         $header=(ord($file[0])==128);
<a name="l00382"></a>00382                         <span class="keywordflow">if</span>($header)
<a name="l00383"></a>00383                         {
<a name="l00384"></a>00384                                 <span class="comment">//Strip first binary header</span>
<a name="l00385"></a>00385                                 $file=substr($file,6);
<a name="l00386"></a>00386                         }
<a name="l00387"></a>00387                         $pos=strpos($file,<span class="stringliteral">'eexec'</span>);
<a name="l00388"></a>00388                         <span class="keywordflow">if</span>(!$pos)
<a name="l00389"></a>00389                                 die(<span class="stringliteral">'&lt;b&gt;Error:&lt;/b&gt; font file does not seem to be valid Type1'</span>);
<a name="l00390"></a>00390                         $size1=$pos+6;
<a name="l00391"></a>00391                         <span class="keywordflow">if</span>($header &amp;&amp; ord($file[$size1])==128)
<a name="l00392"></a>00392                         {
<a name="l00393"></a>00393                                 <span class="comment">//Strip second binary header</span>
<a name="l00394"></a>00394                                 $file=substr($file,0,$size1).substr($file,$size1+6);
<a name="l00395"></a>00395                         }
<a name="l00396"></a>00396                         $pos=strpos($file,<span class="stringliteral">'00000000'</span>);
<a name="l00397"></a>00397                         <span class="keywordflow">if</span>(!$pos)
<a name="l00398"></a>00398                                 die(<span class="stringliteral">'&lt;b&gt;Error:&lt;/b&gt; font file does not seem to be valid Type1'</span>);
<a name="l00399"></a>00399                         $size2=$pos-$size1;
<a name="l00400"></a>00400                         $file=substr($file,0,$size1+$size2);
<a name="l00401"></a>00401                 }
<a name="l00402"></a>00402                 <span class="keywordflow">if</span>(function_exists(<span class="stringliteral">'gzcompress'</span>))
<a name="l00403"></a>00403                 {
<a name="l00404"></a>00404                         $cmp=$basename.<span class="stringliteral">'.z'</span>;
<a name="l00405"></a>00405                         <a class="code" href="makefont_8php.html#bd2121a3e400e1df96d0dac02ade77a2">SaveToFile</a>($cmp,gzcompress($file),<span class="charliteral">'b'</span>);
<a name="l00406"></a>00406                         $s.=<span class="stringliteral">'$file=\''</span>.$cmp.<span class="stringliteral">"';\n"</span>;
<a name="l00407"></a>00407                         echo <span class="stringliteral">'Font file compressed ('</span>.$cmp.<span class="stringliteral">')&lt;br&gt;'</span>;
<a name="l00408"></a>00408                 }
<a name="l00409"></a>00409                 <span class="keywordflow">else</span>
<a name="l00410"></a>00410                 {
<a name="l00411"></a>00411                         $s.=<span class="stringliteral">'$file=\''</span>.basename($fontfile).<span class="stringliteral">"';\n"</span>;
<a name="l00412"></a>00412                         echo <span class="stringliteral">'&lt;b&gt;Notice:&lt;/b&gt; font file could not be compressed (zlib extension not available)&lt;br&gt;'</span>;
<a name="l00413"></a>00413                 }
<a name="l00414"></a>00414                 <span class="keywordflow">if</span>($type==<span class="stringliteral">'Type1'</span>)
<a name="l00415"></a>00415                 {
<a name="l00416"></a>00416                         $s.=<span class="stringliteral">'$size1='</span>.$size1.<span class="stringliteral">";\n"</span>;
<a name="l00417"></a>00417                         $s.=<span class="stringliteral">'$size2='</span>.$size2.<span class="stringliteral">";\n"</span>;
<a name="l00418"></a>00418                 }
<a name="l00419"></a>00419                 <span class="keywordflow">else</span>
<a name="l00420"></a>00420                         $s.=<span class="stringliteral">'$originalsize='</span>.filesize($fontfile).<span class="stringliteral">";\n"</span>;
<a name="l00421"></a>00421         }
<a name="l00422"></a>00422         <span class="keywordflow">else</span>
<a name="l00423"></a>00423         {
<a name="l00424"></a>00424                 <span class="comment">//Not embedded font</span>
<a name="l00425"></a>00425                 $s.=<span class="stringliteral">'$file='</span>.<span class="stringliteral">"'';\n"</span>;
<a name="l00426"></a>00426         }
<a name="l00427"></a>00427         $s.=<span class="stringliteral">"?&gt;\n"</span>;
<a name="l00428"></a>00428         <a class="code" href="makefont_8php.html#bd2121a3e400e1df96d0dac02ade77a2">SaveToFile</a>($basename.<span class="stringliteral">'.php'</span>,$s,<span class="charliteral">'t'</span>);
<a name="l00429"></a>00429         echo <span class="stringliteral">'Font definition file generated ('</span>.$basename.<span class="stringliteral">'.php'</span>.<span class="stringliteral">')&lt;br&gt;'</span>;
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 ?&gt;
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Jan 16 16:56:28 2009 for mailformplusplus by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
